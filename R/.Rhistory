head(cards.oct)
head(stops.oct)
nrow(cards.oct)
x <- cards.oct %>% filter(BusStopId %in% stops.oct$stop_id)
head(x)
nrow(x)
nrow(cards.oct)
cards.oct <<- cards.oct %>% filter(BusStopId %in% stops.oct$stop_id)
saveRDS(cards.oct,paste0(chipCards.oct,".RDS"))
head(cards.sto)
head(cards.oct)
cards.sto %>%
group_by(DateDeplacement) %>%
head()
chipCards.sto <<- "/Users/lavieestuntoucan/civ-sto/data/cartes_a_puces/sto/destination_estimee/Deplacement2017JanFev.CSV"
cards.sto <<- fread(chipCards.sto,sep="~",colClasses=c(NumCarteSerie="character"),header=TRUE)
head(cards.sto)
## Change to date and weekdays
cards.sto <<- cards.sto %>%
mutate(DateDeplacement = as.Date(DateDeplacement),
weekday = weekdays(DateDeplacement) )
##
DateDeplacement <- c(cards.sto$DateDeplacement,cards.sto$DateDeplacement,cards.sto$DateDeplacement,
cards.sto$DateDeplacement,cards.sto$DateDeplacement,cards.sto$DateDeplacement,
cards.sto$DateDeplacement,cards.sto$DateDeplacement,cards.sto$DateDeplacement,cards.sto$DateDeplacement)
NumCarteSerie <- c(cards.sto$NumCarteSerie,cards.sto$NumCarteSerie,cards.sto$NumCarteSerie,
cards.sto$NumCarteSerie,cards.sto$NumCarteSerie,cards.sto$NumCarteSerie,
cards.sto$NumCarteSerie,cards.sto$NumCarteSerie,cards.sto$NumCarteSerie,cards.sto$NumCarteSerie)
LibelTitre <- c(cards.sto$LibelTitre,cards.sto$LibelTitre,cards.sto$LibelTitre,
cards.sto$LibelTitre,cards.sto$LibelTitre,cards.sto$LibelTitre,
cards.sto$LibelTitre,cards.sto$LibelTitre,cards.sto$LibelTitre,cards.sto$LibelTitre)
## transform all columns to NA if empty
cards.sto <<- cards.sto %>% mutate_all(funs(empty_as_na))
## append all trips
HeureTransaction <- c(cards.sto$HeureTransaction,cards.sto$HeureTransaction2,cards.sto$HeureTransaction3,
cards.sto$HeureTransaction4,cards.sto$HeureTransaction5,cards.sto$HeureTransaction6,
cards.sto$HeureTransaction7,cards.sto$HeureTransaction8,cards.sto$HeureTransaction9,cards.sto$HeureTransaction10)
NoLigne <- c(cards.sto$NoLigne1,cards.sto$NoLigne2,cards.sto$NoLigne3,
cards.sto$NoLigne4,cards.sto$NoLigne5,cards.sto$NoLigne6,
cards.sto$NoLigne7,cards.sto$NoLigne8,cards.sto$NoLigne9,cards.sto$NoLigne10)
NumArret <- c(cards.sto$NumArret1,cards.sto$NumArret2,cards.sto$NumArret3,
cards.sto$NumArret4,cards.sto$NumArret5,cards.sto$NumArret6,
cards.sto$NumArret7,cards.sto$NumArret8,cards.sto$NumArret9,cards.sto$NumArret10)
NumArretDebarquement <- c(cards.sto$NumArretDebarquement1,cards.sto$NumArretDebarquement2,cards.sto$NumArretDebarquement3,
cards.sto$NumArretDebarquement4,cards.sto$NumArretDebarquement5,cards.sto$NumArretDebarquement6,
cards.sto$NumArretDebarquement7,cards.sto$NumArretDebarquement8,cards.sto$NumArretDebarquement9,cards.sto$NumArretDebarquement10)
## Make de dataframe
cards.sto <<- data.frame(NumCarteSerie,LibelTitre,DateDeplacement,HeureTransaction,NoLigne,NumArret,NumArretDebarquement)
#cards.sto <<- cards.sto %>% filter(!is.na(NumArretDebarquement))
## Hour
cards.sto <<- cards.sto %>%
separate(col=HeureTransaction, sep=":", into=c("Hres","Mins","Secs")) %>%
mutate(weekday=weekdays(DateDeplacement)) %>%
mutate(HeureTransaction = round(as.numeric(Hres) + as.numeric(Mins)/60,digits=1)) %>% select(-c(Hres,Mins,Secs))
cards.sto <<- cards.sto %>% filter(DateDeplacement >= first.day & DateDeplacement <= last.day)
cards.sto <<- cards.sto %>% filter(weekday %in% my.week)
cards.sto <<- cards.sto %>% filter(NoLigne %in% routes.sto)
saveRDS(cards.sto,paste0(chipCards.sto,".RDS"))
head(cards.sto)
head(cards.oct)
cards.sto %>%
group_by(DateDeplacement) %>%
head()
class(cards.oct)
setDT(cards.oct)
setDT(cards.sto)
class(cards.oct)
head(cards.oct)
head(cards.sto)
setDT(cards.oct,key=c("date","FarecardID"))
setDT(cards.sto,key=c("DateDeplacement","NumCarteSerie"))
head(cards.oct)
cards.sto %>%
group_by(DateDeplacement) %>% head()
d <- cards.sto %>%
group_by(DateDeplacement) %>% head()
d
d.oct <- cards.oct[date == d$DateDeplacement[1]]
nrow(d.oct)
head(cards.oct)
cards.sto %>%
group_by(NumCarteSerie) %>% head()
d
d <- d[1,]
d
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time - d$HeureTransaction < 1]
d.oct
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time - d$HeureTransaction < 1]
}
cards.sto %>% head() %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
print(d)
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time - d$HeureTransaction < 1]
}
search.corr <- function(d){
print(d)
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time - d$HeureTransaction < 1]
}
cards.sto %>% head() %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
#print(d)
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time - d$HeureTransaction < 1]
}
cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time - d$HeureTransaction < 1]
if( nrow(d.oct) > 0 ) cat(paste(d$NumCarteSerie,d$DateDeplacement,d$HeureTransaction,d$NoLigne,d$NumArret,d.oct$Time,d.oct$BusStopId,d.oct$HastusTripId))
}
cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time - d$HeureTransaction < 1]
if( nrow(d.oct) > 0 ) cat(paste(d$NumCarteSerie,d$DateDeplacement,
d$HeureTransaction,d$NoLigne,
d$NumArret,d.oct$Time,
d.oct$BusStopId,d.oct$HastusTripId,"\n"))
}
cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time - d$HeureTransaction < 1]
if( nrow(d.oct) > 0 ) cat(paste(d$NumCarteSerie,d$DateDeplacement,
d$HeureTransaction,d$NoLigne,
d$NumArret,d.oct$Time,
d.oct$BusStopId,d.oct$HastusTripId,"\n",sep="\t"))
}
cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1]
if( nrow(d.oct) > 0 ) cat(paste(d$NumCarteSerie,d$DateDeplacement,
d$HeureTransaction,d$NoLigne,
d$NumArret,d.oct$Time,
d.oct$BusStopId,d.oct$HastusTripId,"\n",sep="\t"))
}
cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
d.out <- data.frame(NumCarteSerie=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- d$NumCarteSerie
d.out$date <- d$DateDeplacement
d.out$HeureA <- d$HeureTransaction
d.out$LigneA <- d$NoLigne
d.out$StopA <- d$NumArret
d.out$HeureB <- d.oct$Time
d.out$StopB <- d.oct$BusStopId
d.out$TripB <- d.oct$HastusTripId
}
}
corr.sto-oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
corr.sto-oct <- cards.sto %>% head(10) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- d$NumCarteSerie
d.out$date <- d$DateDeplacement
d.out$HeureA <- d$HeureTransaction
d.out$LigneA <- d$NoLigne
d.out$StopA <- d$NumArret
d.out$HeureB <- d.oct$Time
d.out$StopB <- d.oct$BusStopId
d.out$TripB <- d.oct$HastusTripId
}
}
corr.sto-oct <- cards.sto %>% head(10) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
cards.sto %>% head(10)
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- d$NumCarteSerie
d.out$date <- d$DateDeplacement
d.out$HeureA <- d$HeureTransaction
d.out$LigneA <- d$NoLigne
d.out$StopA <- d$NumArret
d.out$HeureB <- d.oct$Time
d.out$StopB <- d.oct$BusStopId
d.out$TripB <- d.oct$HastusTripId
print(d.out)
}
}
cards.sto %>% head(10) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- d$NoLigne
d.out$StopA <- d$NumArret
d.out$HeureB <- d.oct$Time
d.out$StopB <- d.oct$BusStopId
d.out$TripB <- d.oct$HastusTripId
print(d.out)
}
}
corr.sto-oct <- cards.sto %>% head(10) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- d$NoLigne
d.out$StopA <- d$NumArret
d.out$HeureB <- d.oct$Time
d.out$StopB <- d.oct$BusStopId
d.out$TripB <- d.oct$HastusTripId
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(10) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(10) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
print(d)
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
print(d)
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
i <<- 1
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
print(i)
i <<- i +1
print(d)
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
i <<- 1
search.corr <- function(d){
print(i)
i <<- i +1
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
print(d)
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
cards.sto[93,]
cards.sto[94,]
i <<- 1
search.corr <- function(d){
print(i)
i <<- i +1
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
print(as.character(d$NumCarteSerie))
print(as.Date(d$DateDeplacement))
print(as.numeric(d$HeureTransaction))
print(as.character(d$NoLigne))
print(as.character(d$NumArret))
print(as.numeric(d.oct$Time))
print(as.character(d.oct$BusStopId))
print(as.numeric(d.oct$HastusTripId))
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
d <- cards.sto[94,]
cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d
d.oct %>% filter(Time - HeureTransaction == min(Time - HeureTransaction))
d.oct %>% filter(Time - HeureTransaction == min(Time - HeureTransaction))
d.oct %>% mutate(dmin = Time - HeureTransaction)
cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
d.oct %>% filter(Time - HeureTransaction == min(Time - HeureTransaction))
d.oct %>% filter(Time - d$HeureTransaction == min(Time - d$HeureTransaction))
i <<- 1
search.corr <- function(d){
print(i)
i <<- i +1
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
if( nrow(d.oct) > 1 ){
d.oct <- d.oct %>% filter(Time - d$HeureTransaction == min(Time - d$HeureTransaction))
}
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
print(as.character(d$NumCarteSerie))
print(as.Date(d$DateDeplacement))
print(as.numeric(d$HeureTransaction))
print(as.character(d$NoLigne))
print(as.character(d$NumArret))
print(as.numeric(d.oct$Time))
print(as.character(d.oct$BusStopId))
print(as.numeric(d.oct$HastusTripId))
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
print(d.out)
}
}
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
search.corr <- function(d){
d.oct <- cards.oct[date == d$DateDeplacement & FarecardID == d$NumCarteSerie & Time > d$HeureTransaction & Time - d$HeureTransaction < 1.5]
if( nrow(d.oct) > 1 ){
d.oct <- d.oct %>% filter(Time - d$HeureTransaction == min(Time - d$HeureTransaction))
}
d.out <- data.frame(NumCarte=NA,date=NA,HeureA=NA,LigneA=NA,StopA=NA,HeureB=NA,StopB=NA,TripB=NA)
if( nrow(d.oct) == 0 ) return(d.out)
else{
d.out$NumCarte <- as.character(d$NumCarteSerie)
d.out$date <- as.Date(d$DateDeplacement)
d.out$HeureA <- as.numeric(d$HeureTransaction)
d.out$LigneA <- as.character(d$NoLigne)
d.out$StopA <- as.character(d$NumArret)
d.out$HeureB <- as.numeric(d.oct$Time)
d.out$StopB <- as.character(d.oct$BusStopId)
d.out$TripB <- as.numeric(d.oct$HastusTripId)
}
return(d.out)
}
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.))
corr.sto.oct
corr.sto.oct <- cards.sto %>% head(100) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.)) %>%
filter(!is.na(NumCarte))
corr.sto.oct
nrow(cards.sto)
268122/100
5*268122/100
5*268122/100/60
5*268122/100/60/60
corr.sto.oct <- cards.sto %>% head(200) %>%
group_by(NumCarteSerie) %>%
rowwise() %>%
do(search.corr(.)) %>%
filter(!is.na(NumCarte))
corr.sto.oct
head(cards.sto)
chipCards.sto <<- "/Users/lavieestuntoucan/civ-sto/data/cartes_a_puces/sto/destination_estimee/Deplacement2017JanFev.CSV"
cards.sto <<- fread(chipCards.sto,sep="~",colClasses=c(NumCarteSerie="character"),header=TRUE)
head(cards.sto)
